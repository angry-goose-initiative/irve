# CMakeLists.txt
# Copyright (C) 2023-2024 John Jekel
# See the LICENSE file at the root of the project for licensing info.
#
# CMake configuration file for irve unit tests
#
# Based on CMakeLists.txt from rv32esim
#

#Common options
cmake_minimum_required(VERSION 3.16.3)
include(CTest)

set(
    UNIT_TESTER_SOURCES
    ${CMAKE_CURRENT_SOURCE_DIR}/common.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/cpu_state.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/CSR.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/decode.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/logging.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/memory.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/uart.cpp
    ${CMAKE_CURRENT_BINARY_DIR}/unit_tester.cpp
)

add_executable(unit_tester ${UNIT_TESTER_SOURCES})
target_include_directories(unit_tester PRIVATE ${PROJECT_SOURCE_DIR}/include/)#To get access to the public libirve headers
#Unit tests need access to the internal libirve headers (including the autogenerated ones)
target_include_directories(unit_tester PRIVATE ${PROJECT_SOURCE_DIR}/lib/ ${CMAKE_BINARY_DIR}/lib)
target_link_libraries(unit_tester PRIVATE libirve_object)#TODO or should we make this static or shared instead?
set(UNIT_TEST_LIST "")
macro(add_unit_test TEST_NAME)
    add_test(NAME unit_${TEST_NAME} COMMAND unit_tester ${TEST_NAME})
    set(UNIT_TEST_LIST "${UNIT_TEST_LIST} X(${TEST_NAME})")
    set_property(TEST unit_${TEST_NAME} PROPERTY REQUIRED_FILES "$<TARGET_FILE:unit_tester>")
endmacro()
macro(add_integration_test)
    #Do nothing
endmacro()
macro(add_rvsw_test)
    #Do nothing
endmacro()
macro(add_rvsw_parse_test)
    #Do nothing
endmacro()
macro(add_rvsw_smode_parse_test)
    #Do nothing
endmacro()

include(${CMAKE_CURRENT_SOURCE_DIR}/../test_list.txt)

#Put the list of unit tests in the unit tester file (THIS MUST COME AFTER INCLUDING THE TEST LIST)
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/unit_tester.cpp.in
    ${CMAKE_CURRENT_BINARY_DIR}/unit_tester.cpp
    @ONLY
)
