# CMakeLists.txt
# Copyright (C) 2023-2024 John Jekel
# See the LICENSE file at the root of the project for licensing info.
#
# CMake configuration file for irve testfile verification and parsing tests
#
# Based on CMakeLists.txt from rv32esim
#

#Common options
cmake_minimum_required(VERSION 3.16.3)
include(CTest)

set(
    RVSW_TESTER_SOURCES
    ${CMAKE_CURRENT_BINARY_DIR}/rvsw_verifier.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/jzjcoresoftware.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/standalone.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/elf.cpp
)

add_executable(rvsw_verifier ${RVSW_TESTER_SOURCES})
target_include_directories(rvsw_verifier PRIVATE ${PROJECT_SOURCE_DIR}/include/)#To get access to the public libirve headers
#Testfiles tests need access to the internal libirve headers (including the autogenerated ones)
target_include_directories(rvsw_verifier PRIVATE ${PROJECT_SOURCE_DIR}/lib/ ${CMAKE_BINARY_DIR}/lib)
target_link_libraries(rvsw_verifier PRIVATE libirve_object)#TODO or should we make this static or shared instead?
#add_dependencies(rvsw_verifier irve_testfiles)#We depend on the testfiles being generated#FIXME express dependency of testfiles_tester on rvsw testfiles being compiled
set(RVSW_TEST_LIST "")
macro(add_rvsw_test TEST_NAME)
    #The working directory is important because tests will need to access the rvsw testfiles
    add_test(NAME rvsw_${TEST_NAME} COMMAND rvsw_verifier ${TEST_NAME} WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}")
    set(RVSW_TEST_LIST "${RVSW_TEST_LIST} X(${TEST_NAME})")
    set_property(TEST rvsw_${TEST_NAME} PROPERTY REQUIRED_FILES "$<TARGET_FILE:rvsw_verifier>")
endmacro()

macro(add_rvsw_parse_test TEST_NAME REL_PATH)#Useful for C tests that have assertions in RISC-V code rather than in rvsw_verifier
    add_test(NAME rvsw_parse_${TEST_NAME} COMMAND irve "rvsw/compiled/${REL_PATH}.vhex8" WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}")
    set_property(TEST rvsw_parse_${TEST_NAME} PROPERTY PASS_REGULAR_EXPRESSION "IRVE is shutting down. Bye bye!")
    #The way we did assertions pre-newlib and Newlib-style respectively
    set_property(TEST rvsw_parse_${TEST_NAME} PROPERTY FAIL_REGULAR_EXPRESSION "Assertion failed;assertion \".*\" failed")
    set_property(TEST rvsw_parse_${TEST_NAME} PROPERTY REQUIRED_FILES "$<TARGET_FILE:irve>")
endmacro()
macro(add_rvsw_smode_parse_test TEST_NAME REL_PATH)#Useful for C tests that have assertions in RISC-V code rather than in rvsw_verifier
    add_test(NAME rvsw_smode_parse_${TEST_NAME} COMMAND irve "rvsw/compiled/sbi/ogsbi/ogsbi.vhex8" "rvsw/compiled/${REL_PATH}.vhex8" WORKING_DIRECTORY "${PROJECT_SOURCE_DIR}")
    set_property(TEST rvsw_smode_parse_${TEST_NAME} PROPERTY PASS_REGULAR_EXPRESSION "IRVE is shutting down. Bye bye!")
    #The way we did assertions pre-newlib and Newlib-style respectively
    set_property(TEST rvsw_smode_parse_${TEST_NAME} PROPERTY FAIL_REGULAR_EXPRESSION "Assertion failed;assertion \".*\" failed")
    set_property(TEST rvsw_smode_parse_${TEST_NAME} PROPERTY REQUIRED_FILES "$<TARGET_FILE:irve>")
endmacro()
macro(add_unit_test)
    #Do nothing
endmacro()
macro(add_integration_test)
    #Do nothing
endmacro()

include(${CMAKE_CURRENT_SOURCE_DIR}/../test_list.cmake)

#Put the list of testfiles tests in the testfiles tester file (THIS MUST COME AFTER INCLUDING THE TEST LIST)
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/rvsw_verifier.cpp.in
    ${CMAKE_CURRENT_BINARY_DIR}/rvsw_verifier.cpp
    @ONLY
)
